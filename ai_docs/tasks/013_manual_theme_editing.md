# AI Task Template

> **Task:** Manual Theme Editing - Add color pickers, font dropdowns, and live preview editing

---

## 1. Task Overview

### Task Title
**Title:** Manual Theme Editing UI

### Goal Statement
**Goal:** Allow users to manually adjust theme colors, fonts, and component styles after AI generation. This makes the "Duplicate Theme" feature useful - users can duplicate a theme and tweak it, or manually adjust any theme to better fit their needs.

---

## 2. Strategic Analysis & Solution Options

### Problem Context
Currently, themes are generated by AI and are view-only. Users cannot:
- Adjust a color that doesn't quite work
- Change fonts while keeping colors
- Fine-tune border radius or other component settings

The `updateThemeData` action already exists in `app/actions/theme.ts` but has no UI.

### Solution Options Analysis

#### Option 1: Edit Mode in Preview Sheet (Recommended)
**Approach:** Enhance the existing theme preview sheet with edit controls. When user clicks "Edit" on a theme, the sheet opens with editable color pickers, font dropdowns, and sliders.

**Pros:**
- ✅ Reuses existing preview sheet UI
- ✅ Side-by-side edit controls + live preview
- ✅ Minimal new components needed
- ✅ Consistent UX with current flow

**Cons:**
- ❌ Sheet might feel cramped with many controls
- ❌ Need to handle save/cancel state

**Implementation Complexity:** Medium
**Risk Level:** Low

#### Option 2: Dedicated Theme Editor Page
**Approach:** Create a new page `/app/sites/[siteId]/theme/[themeId]/edit` with full editing capabilities.

**Pros:**
- ✅ More space for controls
- ✅ Could add advanced features later

**Cons:**
- ❌ More navigation required
- ❌ Disrupts current tab-based flow
- ❌ More files to create

**Implementation Complexity:** Medium-High
**Risk Level:** Medium

### Recommendation & Rationale

**RECOMMENDED SOLUTION:** Option 1 - Edit Mode in Preview Sheet

**Why this is the best choice:**
1. **Consistent UX** - Keeps everything in the Theme tab
2. **Faster to implement** - Reuses existing sheet component
3. **Live preview** - Users see changes immediately in the same view
4. **Easy to extend** - Can add more controls later

---

## 3. Project Analysis & Current State

### Technology & Architecture
- **Frameworks & Versions:** Next.js 15, React 19
- **UI & Styling:** shadcn/ui + Tailwind CSS
- **State:** Local state with auto-save or explicit save button

### Current State
- `ThemeTab.tsx` - Shows active theme, "Generate New Theme" button, saved themes list
- `ThemePreview.tsx` - Read-only preview with colors, typography, components
- `app/actions/theme.ts` - Has `updateThemeData(themeId, themeData)` action
- `trigger/utils/font-list.ts` - Curated Google Fonts (40+ fonts in categories)

### Existing Codebase Analysis

**Relevant Files:**
- `components/theme/ThemeTab.tsx` - Entry point, opens preview sheet
- `components/theme/ThemePreview.tsx` - Will enhance with edit mode
- `components/theme/SavedThemesList.tsx` - Theme cards with actions
- `app/actions/theme.ts` - `updateThemeData()` exists
- `lib/drizzle/schema/theme-types.ts` - ThemeData, ColorPalette, TypographySettings interfaces
- `trigger/utils/font-list.ts` - ALL_FONTS, SANS_SERIF_FONTS, SERIF_FONTS, etc.

---

## 4. Context & Problem Definition

### Problem Statement
Users need to manually edit themes because:
1. AI-generated themes are close but not perfect
2. Brand colors may need exact hex values
3. Font preferences are subjective
4. Component styling (border radius) affects the site feel

Without editing, users must regenerate entire themes hoping for better results.

### Success Criteria
- [ ] Users can edit all 8 theme colors using color pickers
- [ ] Users can select heading font from curated list
- [ ] Users can select body font from curated list
- [ ] Users can adjust border radius for components
- [ ] Changes are reflected in live preview
- [ ] Save button persists changes to database
- [ ] Cancel/close discards unsaved changes

---

## 5. Development Mode Context

- **New application in active development**
- **No backwards compatibility concerns**
- **Priority: Speed and simplicity**

---

## 6. Technical Requirements

### Functional Requirements
- User can click "Edit" button on any theme to open editor
- Color pickers for: primary, secondary, accent, background, foreground, muted, mutedForeground, border
- Font dropdowns populated from `font-list.ts` categories
- Border radius slider (0-24px range)
- Live preview updates as values change
- Save button commits changes via `updateThemeData`
- Close without saving discards changes (confirm if dirty)

### Non-Functional Requirements
- **Performance:** Color picker changes should feel instant (local state)
- **Usability:** Labels should be clear, preview should be visible
- **Responsive:** Works on tablet and desktop (sheet may be full-screen on mobile)

### Technical Constraints
- Must use existing `updateThemeData` action
- Must regenerate `cssVariables` and `tailwindExtends` when colors change
- Should use lightweight color picker library (react-colorful recommended)

---

## 7. Data & Database Changes

**No database changes required.** Using existing `themes.data` JSONB column.

---

## 8. Backend Changes & Background Jobs

**No backend changes required.** The `updateThemeData` action already exists.

### Helper Function Needed
Need to regenerate `cssVariables` and `tailwindExtends` when theme data changes. Extract or reuse logic from `trigger/utils/tailwind-generator.ts`.

---

## 9. Frontend Changes

### New Dependencies
```bash
npm install react-colorful
```
**react-colorful:** Lightweight color picker (2.8KB gzipped), no dependencies, accessible.

### New Components

#### `components/theme/ThemeEditor.tsx`
Main editor component with:
- Color picker section (8 colors)
- Typography section (heading font, body font dropdowns)
- Component styles section (border radius slider)
- Save/Cancel buttons
- Integration with ThemePreview for live preview

#### `components/theme/ColorPickerField.tsx`
Reusable color picker field with:
- Label
- Hex input
- Color picker popover
- Visual swatch preview

#### `components/theme/FontSelect.tsx`
Font family dropdown with:
- Categorized options (Sans-serif, Serif, Display, Monospace)
- Preview of font in dropdown

### Component Modifications

#### `components/theme/ThemeTab.tsx`
- Add edit mode state
- Pass edit handler to saved themes list
- Handle edit sheet open/close

#### `components/theme/SavedThemesList.tsx`
- Add "Edit" button to theme cards (alongside Activate, Delete, Duplicate)

#### `components/theme/ThemePreview.tsx`
- No changes needed (already accepts ThemeData prop)

### Files to Create
```
components/theme/
├── ThemeEditor.tsx       # Main editor with all controls
├── ColorPickerField.tsx  # Reusable color picker
└── FontSelect.tsx        # Font family dropdown
```

### Files to Modify
```
components/theme/ThemeTab.tsx         # Add edit mode
components/theme/SavedThemesList.tsx  # Add edit button
lib/theme-utils.ts                    # NEW: Helper to regenerate CSS/Tailwind
```

---

## 10. Code Changes Overview

### New: `components/theme/ColorPickerField.tsx`
```tsx
"use client";

import { useState } from "react";
import { HexColorPicker, HexColorInput } from "react-colorful";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Label } from "@/components/ui/label";

interface ColorPickerFieldProps {
  label: string;
  value: string;
  onChange: (color: string) => void;
}

export function ColorPickerField({ label, value, onChange }: ColorPickerFieldProps) {
  const [open, setOpen] = useState(false);

  return (
    <div className="space-y-1.5">
      <Label className="text-xs">{label}</Label>
      <Popover open={open} onOpenChange={setOpen}>
        <PopoverTrigger asChild>
          <button
            type="button"
            className="flex items-center gap-2 w-full h-9 px-3 rounded-md border bg-background text-sm"
          >
            <div
              className="w-5 h-5 rounded border"
              style={{ backgroundColor: value }}
            />
            <span className="font-mono text-xs">{value}</span>
          </button>
        </PopoverTrigger>
        <PopoverContent className="w-auto p-3" align="start">
          <HexColorPicker color={value} onChange={onChange} />
          <HexColorInput
            color={value}
            onChange={onChange}
            prefixed
            className="mt-2 w-full h-8 px-2 text-sm font-mono rounded border"
          />
        </PopoverContent>
      </Popover>
    </div>
  );
}
```

### New: `components/theme/FontSelect.tsx`
```tsx
"use client";

import {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import {
  SANS_SERIF_FONTS,
  SERIF_FONTS,
  DISPLAY_FONTS,
} from "@/trigger/utils/font-list";

interface FontSelectProps {
  label: string;
  value: string;
  onChange: (font: string) => void;
  type: "heading" | "body";
}

export function FontSelect({ label, value, onChange, type }: FontSelectProps) {
  // Heading fonts can use display fonts, body fonts shouldn't
  const showDisplay = type === "heading";

  return (
    <div className="space-y-1.5">
      <Label className="text-xs">{label}</Label>
      <Select value={value} onValueChange={onChange}>
        <SelectTrigger>
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectGroup>
            <SelectLabel>Sans-Serif</SelectLabel>
            {SANS_SERIF_FONTS.map((font) => (
              <SelectItem key={font} value={font} style={{ fontFamily: font }}>
                {font}
              </SelectItem>
            ))}
          </SelectGroup>
          <SelectGroup>
            <SelectLabel>Serif</SelectLabel>
            {SERIF_FONTS.map((font) => (
              <SelectItem key={font} value={font} style={{ fontFamily: font }}>
                {font}
              </SelectItem>
            ))}
          </SelectGroup>
          {showDisplay && (
            <SelectGroup>
              <SelectLabel>Display</SelectLabel>
              {DISPLAY_FONTS.map((font) => (
                <SelectItem key={font} value={font} style={{ fontFamily: font }}>
                  {font}
                </SelectItem>
              ))}
            </SelectGroup>
          )}
        </SelectContent>
      </Select>
    </div>
  );
}
```

### New: `components/theme/ThemeEditor.tsx` (Simplified Structure)
```tsx
"use client";

import { useState, useTransition } from "react";
import { Button } from "@/components/ui/button";
import { Slider } from "@/components/ui/slider";
import { Label } from "@/components/ui/label";
import { Separator } from "@/components/ui/separator";
import { ColorPickerField } from "./ColorPickerField";
import { FontSelect } from "./FontSelect";
import { ThemePreview } from "./ThemePreview";
import { updateThemeData } from "@/app/actions/theme";
import { regenerateThemeOutput } from "@/lib/theme-utils";
import type { ThemeData } from "@/lib/drizzle/schema/theme-types";

interface ThemeEditorProps {
  themeId: string;
  initialData: ThemeData;
  onSave: () => void;
  onCancel: () => void;
}

export function ThemeEditor({ themeId, initialData, onSave, onCancel }: ThemeEditorProps) {
  const [data, setData] = useState<ThemeData>(initialData);
  const [isPending, startTransition] = useTransition();

  const updateColor = (key: string, value: string) => {
    setData((prev) => ({
      ...prev,
      colors: { ...prev.colors, [key]: value },
    }));
  };

  const updateHeadingFont = (family: string) => {
    setData((prev) => ({
      ...prev,
      typography: {
        ...prev.typography,
        headingFont: { ...prev.typography.headingFont, family },
      },
    }));
  };

  const updateBodyFont = (family: string) => {
    setData((prev) => ({
      ...prev,
      typography: {
        ...prev.typography,
        bodyFont: { ...prev.typography.bodyFont, family },
      },
    }));
  };

  const updateBorderRadius = (value: number) => {
    const radius = `${value / 16}rem`;
    setData((prev) => ({
      ...prev,
      components: {
        ...prev.components,
        button: { ...prev.components.button, borderRadius: radius },
        card: { ...prev.components.card, borderRadius: radius },
        input: { ...prev.components.input, borderRadius: radius },
        badge: { ...prev.components.badge, borderRadius: radius },
      },
    }));
  };

  const handleSave = () => {
    startTransition(async () => {
      const finalData = regenerateThemeOutput(data);
      const result = await updateThemeData(themeId, finalData);
      if (result.success) {
        onSave();
      }
    });
  };

  return (
    <div className="flex flex-col h-full">
      {/* Scrollable content */}
      <div className="flex-1 overflow-y-auto space-y-6 pr-2">
        {/* Colors Section */}
        <div>
          <h4 className="font-medium mb-3">Colors</h4>
          <div className="grid grid-cols-2 gap-3">
            <ColorPickerField label="Primary" value={data.colors.primary} onChange={(v) => updateColor("primary", v)} />
            <ColorPickerField label="Secondary" value={data.colors.secondary} onChange={(v) => updateColor("secondary", v)} />
            <ColorPickerField label="Accent" value={data.colors.accent} onChange={(v) => updateColor("accent", v)} />
            <ColorPickerField label="Background" value={data.colors.background} onChange={(v) => updateColor("background", v)} />
            <ColorPickerField label="Text" value={data.colors.foreground} onChange={(v) => updateColor("foreground", v)} />
            <ColorPickerField label="Muted" value={data.colors.muted} onChange={(v) => updateColor("muted", v)} />
            <ColorPickerField label="Muted Text" value={data.colors.mutedForeground} onChange={(v) => updateColor("mutedForeground", v)} />
            <ColorPickerField label="Border" value={data.colors.border} onChange={(v) => updateColor("border", v)} />
          </div>
        </div>

        <Separator />

        {/* Typography Section */}
        <div>
          <h4 className="font-medium mb-3">Typography</h4>
          <div className="grid grid-cols-2 gap-3">
            <FontSelect label="Heading Font" value={data.typography.headingFont.family} onChange={updateHeadingFont} type="heading" />
            <FontSelect label="Body Font" value={data.typography.bodyFont.family} onChange={updateBodyFont} type="body" />
          </div>
        </div>

        <Separator />

        {/* Border Radius Section */}
        <div>
          <h4 className="font-medium mb-3">Border Radius</h4>
          <div className="space-y-2">
            <Label className="text-xs">Component Roundness</Label>
            <Slider
              defaultValue={[parseFloat(data.components.button.borderRadius) * 16 || 8]}
              max={24}
              step={1}
              onValueChange={([v]) => updateBorderRadius(v)}
            />
            <div className="flex justify-between text-xs text-muted-foreground">
              <span>Square</span>
              <span>Rounded</span>
            </div>
          </div>
        </div>

        <Separator />

        {/* Live Preview */}
        <div>
          <h4 className="font-medium mb-3">Preview</h4>
          <ThemePreview theme={data} />
        </div>
      </div>

      {/* Fixed footer with buttons */}
      <div className="flex gap-2 pt-4 border-t mt-4">
        <Button variant="outline" className="flex-1" onClick={onCancel} disabled={isPending}>
          Cancel
        </Button>
        <Button className="flex-1" onClick={handleSave} disabled={isPending}>
          {isPending ? "Saving..." : "Save Changes"}
        </Button>
      </div>
    </div>
  );
}
```

### New: `lib/theme-utils.ts`
Helper to regenerate CSS variables and Tailwind extends:
```tsx
import type { ThemeData, ColorPalette, TypographySettings } from "@/lib/drizzle/schema/theme-types";

/**
 * Regenerate cssVariables and tailwindExtends after manual edits.
 */
export function regenerateThemeOutput(data: ThemeData): ThemeData {
  return {
    ...data,
    cssVariables: generateCSSVariables(data.colors, data.typography),
    tailwindExtends: generateTailwindExtends(data),
  };
}

function generateCSSVariables(colors: ColorPalette, typography: TypographySettings): string {
  return `:root {
  --color-primary: ${colors.primary};
  --color-secondary: ${colors.secondary};
  --color-accent: ${colors.accent};
  --color-background: ${colors.background};
  --color-foreground: ${colors.foreground};
  --color-muted: ${colors.muted};
  --color-muted-foreground: ${colors.mutedForeground};
  --color-border: ${colors.border};
  --font-heading: "${typography.headingFont.family}", sans-serif;
  --font-body: "${typography.bodyFont.family}", sans-serif;
}`;
}

function generateTailwindExtends(data: ThemeData): Record<string, unknown> {
  return {
    colors: {
      primary: data.colors.primary,
      secondary: data.colors.secondary,
      accent: data.colors.accent,
      background: data.colors.background,
      foreground: data.colors.foreground,
      muted: data.colors.muted,
      "muted-foreground": data.colors.mutedForeground,
      border: data.colors.border,
    },
    fontFamily: {
      heading: [data.typography.headingFont.family, "sans-serif"],
      body: [data.typography.bodyFont.family, "sans-serif"],
    },
    borderRadius: {
      DEFAULT: data.components.button.borderRadius,
    },
  };
}
```

### Modify: `components/theme/SavedThemesList.tsx`
Add "Edit" button to actions dropdown:
```tsx
// Add to imports
import { Pencil } from "lucide-react";

// Add to DropdownMenuContent (after Activate, before Duplicate)
<DropdownMenuItem onClick={() => onEdit?.(theme)}>
  <Pencil className="h-4 w-4 mr-2" />
  Edit Theme
</DropdownMenuItem>
```

### Modify: `components/theme/ThemeTab.tsx`
Add edit mode handling:
```tsx
// Add state for editing
const [editingTheme, setEditingTheme] = useState<Theme | null>(null);

// In Sheet, conditionally render editor or preview
{editingTheme ? (
  <ThemeEditor
    themeId={editingTheme.id}
    initialData={editingTheme.data}
    onSave={() => { setEditingTheme(null); setIsPreviewOpen(false); }}
    onCancel={() => setEditingTheme(null)}
  />
) : selectedTheme && (
  <ThemePreview theme={selectedTheme.data} showRationale />
)}
```

---

## 11. Implementation Plan

### Phase 1: Install Dependency & Create Helper
**Goal:** Set up foundation

- [ ] **Task 1.1:** Install react-colorful
  - Command: `npm install react-colorful`
- [ ] **Task 1.2:** Create `lib/theme-utils.ts`
  - Files: `lib/theme-utils.ts`
  - Details: Helper to regenerate CSS variables and Tailwind extends

### Phase 2: Create Editor Components
**Goal:** Build the editing UI components

- [ ] **Task 2.1:** Create `ColorPickerField.tsx`
  - Files: `components/theme/ColorPickerField.tsx`
  - Details: Reusable color picker with label, swatch, hex input
- [ ] **Task 2.2:** Create `FontSelect.tsx`
  - Files: `components/theme/FontSelect.tsx`
  - Details: Font dropdown with categorized options
- [ ] **Task 2.3:** Create `ThemeEditor.tsx`
  - Files: `components/theme/ThemeEditor.tsx`
  - Details: Main editor combining all controls + preview

### Phase 3: Integrate into Theme Tab
**Goal:** Connect editor to existing UI

- [ ] **Task 3.1:** Update `SavedThemesList.tsx`
  - Files: `components/theme/SavedThemesList.tsx`
  - Details: Add "Edit" button to theme dropdown menu
- [ ] **Task 3.2:** Update `ThemeTab.tsx`
  - Files: `components/theme/ThemeTab.tsx`
  - Details: Add edit mode state, conditionally show editor in sheet

### Phase 4: Testing & Validation
**Goal:** Verify everything works

- [ ] **Task 4.1:** Run linting and type-check
  - Command: `npm run lint && npm run type-check`
- [ ] **Task 4.2:** Manual browser testing (USER)
  - Test: Open theme, click Edit, change colors
  - Test: Change fonts, verify preview updates
  - Test: Adjust border radius
  - Test: Save changes, verify persistence
  - Test: Cancel discards changes

---

## 12. Task Completion Tracking - MANDATORY WORKFLOW

- [ ] **GET TODAY'S DATE FIRST** - Use time tool before adding timestamps
- [ ] **Update task document immediately** after each completed subtask
- [ ] **Mark checkboxes as [x]** with completion timestamp

---

## 13. File Structure & Organization

### New Files to Create
```
components/theme/
├── ThemeEditor.tsx       # Main editor component
├── ColorPickerField.tsx  # Color picker with label
└── FontSelect.tsx        # Font dropdown

lib/
└── theme-utils.ts        # Regenerate CSS/Tailwind helpers
```

### Files to Modify
- `components/theme/ThemeTab.tsx` - Add edit mode
- `components/theme/SavedThemesList.tsx` - Add edit button

### Dependencies to Add
```json
{
  "dependencies": {
    "react-colorful": "^5.6.1"
  }
}
```

---

## 14. Potential Issues & Security Review

### Error Scenarios to Analyze
- [ ] **Error Scenario 1:** Invalid hex color entered
  - **Code Review Focus:** HexColorInput validation
  - **Potential Fix:** react-colorful handles this gracefully
- [ ] **Error Scenario 2:** Save fails due to network
  - **Code Review Focus:** Error handling in handleSave
  - **Potential Fix:** Show toast error, keep editor open

### Edge Cases to Consider
- [ ] **Edge Case 1:** User closes sheet without saving
  - **Analysis Approach:** Check if changes should be warned
  - **Recommendation:** Optional: Add "unsaved changes" confirmation

### Security & Access Control Review
- [ ] **Authentication:** `updateThemeData` already requires `requireUserId()`
- [ ] **Authorization:** Action verifies theme ownership via user_id

---

## 15. Deployment & Configuration

**No environment variables or configuration changes required.**

---

## 16. AI Agent Instructions

### Implementation Approach
Follow phases sequentially. Test each component individually before integration.

### Code Quality Standards
- [ ] Use TypeScript strict types
- [ ] Follow existing component patterns
- [ ] Use shadcn/ui components where possible
- [ ] Ensure responsive design

---

## 17. Notes & Additional Context

### Design Reference
- Color pickers similar to Figma/design tools
- Font dropdown with preview similar to Canva
- Live preview ensures users see exactly what they get

### Future Enhancements
- Add more typography controls (font sizes, line heights)
- Add more component style controls
- Preset color palettes
- Color harmony suggestions

---

## 18. Second-Order Consequences & Impact Analysis

### Impact Assessment

#### Breaking Changes Analysis
- [ ] **No breaking changes** - purely additive feature

#### Ripple Effects Assessment
- [ ] **ThemePreview** - No changes needed, already accepts ThemeData
- [ ] **Published sites** - Will show updated theme after save

#### Performance Implications
- [ ] **react-colorful** - Only 2.8KB gzipped, minimal impact
- [ ] **Live preview** - Local state updates, no server calls until save

#### Security Considerations
- [ ] **No new attack vectors** - Uses existing authenticated action

### Critical Issues Identification
**No red or yellow flags identified.**

---

*Task Created: 2025-12-27*
*Priority: P1 - High*
*Estimated Effort: Medium (~2-3 hours)*
